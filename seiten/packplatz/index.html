<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AEMP ‚Ä¢ Packplatz ‚Äì V.1.1.22</title>
  <style>
    :root{--bg:#0f172a;--panel:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--accent:#3b82f6;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:12px;
      --w-img:72px;--w-code:140px;--w-name:260px;}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:#050912;color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Inter}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(3,6,15,.95),rgba(3,6,15,.75));border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(8px)}
    .container{max-width:1200px;margin:auto;padding:14px 16px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:#162038;color:#fff;box-shadow:var(--shadow);cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.12)}
    .pill{display:inline-flex;align-items:center;gap:.5ch;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;color:#cbd5e1}
    .layout{max-width:1200px;margin:18px auto;display:grid;grid-template-columns: 1.3fr 1fr;gap:16px;padding:0 16px 80px}
    .panel{background:linear-gradient(180deg,rgba(14,20,35,.96),rgba(14,20,35,.86));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel-body{padding:10px 12px}
    input[type=text]{background:#0b1020;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:#fff;padding:10px 12px;min-width:320px}
    /* table left */ .table-wrap{overflow:auto} table{width:max(1200px,100%);border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.08);white-space:nowrap;text-align:left}
    thead th{position:sticky;top:0;background:rgba(17,24,39,.96);z-index:2;font-size:12px;color:#9fb0c8}
    tbody tr:hover td{background:rgba(255,255,255,.04)}
    th.sticky-0,td.sticky-0{position:sticky;left:0;background:rgba(17,24,39,.98);z-index:3}
    th.sticky-1,td.sticky-1{position:sticky;left:var(--w-img);background:rgba(17,24,39,.98);z-index:3}
    th.sticky-2,td.sticky-2{position:sticky;left:calc(var(--w-img) + var(--w-code));background:rgba(17,24,39,.98);z-index:3}
    th.col-img,td.col-img{width:var(--w-img);min-width:var(--w-img);max-width:var(--w-img)}
    th.col-code,td.col-code{width:var(--w-code);min-width:var(--w-code)}
    th.col-name,td.col-name{width:var(--w-name);min-width:var(--w-name)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:12px}
    .ok{color:#10b981;border-color:#10b98155} .warn{color:#f59e0b;border-color:#f59e0b55} .muted{color:#94a3b8}
    /* context menu */ .ctx{position:fixed;display:none;min-width:250px;background:#0b1020;border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);border-radius:10px;padding:8px;z-index:10}
    .ctx h4{margin:6px 8px 8px;font-size:12px;color:#9fb0c8;letter-spacing:.6px}
    .ctx .item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px} .ctx .item:hover{background:rgba(255,255,255,.06)}
    .ctx input[type=checkbox]{accent-color:#22d3ee}
    /* detail (right) */ .hero{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .thumb{width:96px;height:64px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.12)}
    .grid{display:grid;gap:10px} .grid.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
    .line{display:flex;justify-content:space-between;align-items:center;border-top:1px solid rgba(255,255,255,.06);padding-top:8px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="row" style="gap:8px">
          <a class="btn ghost" href="../../index.html">üè† Home</a>
          <span class="pill">Packplatz</span>
        </div>
        <div class="row" style="gap:8px">
          <span class="pill">Version <strong>V.1.1.22</strong></span>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <label class="pill" for="scanInput">üîé Barcode/K√ºrzel:</label>
        <input id="scanInput" type="text" placeholder="z.‚ÄØB. ACH-101" />
        <button class="btn" id="scanOpen">√ñffnen</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: table replaces old list -->
    <section class="panel">
      <div class="panel-head">
        <strong>Setansicht</strong>
        <span class="muted">Rechtsklick im Kopf: Spalten an/aus</span>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr id="hdr">
              <th class="col-img sticky-0" data-key="img">Set Bild</th>
              <th class="col-code sticky-1" data-key="code">K√ºrzel</th>
              <th class="col-name sticky-2" data-key="name">Set Bezeichnung</th>
              <th data-key="dept">Fachgebiet</th>
              <th data-key="status">Status</th>
              <th data-key="priority">Priorit√§t</th>
              <th data-key="owner">Kostenstelle (Eig.)</th>
              <th data-key="issue">Kostenstelle (Ausgabe)</th>
              <th data-key="loan">Leih-Set</th>
              <th data-key="risk">Risikogruppe</th>
              <th data-key="type">Typ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RIGHT: details view -->
    <section class="panel">
      <div class="panel-head"><strong id="dTitle">‚Äî</strong></div>
      <div class="panel-body">
        <div class="hero">
          <img id="dImg" class="thumb" src="" alt="" />
          <div>
            <div id="dCode" class="muted">‚Äî</div>
            <div id="dDept" class="muted">‚Äî</div>
          </div>
        </div>
        <div class="grid cols-4" id="dMeta"></div>
        <div class="line">
          <div><strong>Instrumente</strong></div>
          <div>
            <button class="btn ghost" id="btnAddImg">Bilder hinzuf√ºgen</button>
          </div>
        </div>
        <table style="width:100%;margin-top:8px">
          <thead><tr><th style="text-align:left">Instrument</th><th>Soll</th><th>Kategorie</th><th>Bilder</th></tr></thead>
          <tbody id="instBody"></tbody>
        </table>
        <div class="line">
          <div class="row" style="gap:10px">
            <a class="btn ghost" href="../../index.html">Home</a>
            <button class="btn ghost">Packformular</button>
            <button class="btn ghost" id="btnCancel">Stornieren</button>
            <button class="btn" id="btnPack">Packen</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="ctx" id="colMenu"><h4>Spalten anzeigen</h4><div id="colList"></div></div>

  <!-- Packdialog (reuse from previous) -->
  <dialog id="packDlg">
    <div class="panel-head">
      <strong id="packTitle">Packvorgang</strong>
      <button class="btn ghost" id="packClose">‚úï</button>
    </div>
    <div class="panel-body">
      <table style="width:100%">
        <thead><tr><th style="text-align:left">Instrument</th><th>Soll</th><th>Ist</th><th>Status</th><th>Grund</th></tr></thead>
        <tbody id="packBody"></tbody>
      </table>
    </div>
    <div class="panel-body" style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn ghost" id="packCancel">Stornieren</button>
      <button class="btn" id="packSave">Speichern</button>
      <button class="btn" id="packComplete">Fertig packen</button>
    </div>
  </dialog>

  <script>
    // Demo dataset aligned with your screenshot codes
    const DATA = [
      {img:'https://via.placeholder.com/72x48?text=ACH-101', code:'ACH-101', name:'Standard-OP Set', dept:'Chirurgie', status:'Freigegeben', priority:'mittel', owner:'KST-1001', issue:'OP-1', loan:'nein', risk:'kritisch A', type:'Mehrweg'},
      {img:'https://via.placeholder.com/72x48?text=ACH-102', code:'ACH-102', name:'Laparoskopie Set', dept:'Chirurgie', status:'Freigegeben', priority:'hoch', owner:'KST-1001', issue:'OP-2', loan:'nein', risk:'semikritisch B', type:'Mehrweg'},
      {img:'https://via.placeholder.com/72x48?text=ACH-103', code:'ACH-103', name:'Orthop√§die Standard', dept:'Ortho', status:'Freigegeben', priority:'niedrig', owner:'KST-2002', issue:'OP-3', loan:'ja', risk:'unkritisch', type:'Mehrweg'}
    ];
    const DEMO_ITEMS = {
      'ACH-101': [
        {id:'i1', name:'Skalpellgriff Nr. 4', req:2, cat:'Schneiden'},
        {id:'i2', name:'Schere Metzenbaum 14 cm', req:1, cat:'Schneiden'},
        {id:'i3', name:'Pinzette anatomisch 14 cm', req:2, cat:'Greifen'},
        {id:'i4', name:'Klemme Kocher gebogen', req:2, cat:'Klemmen'},
        {id:'i5', name:'Nadelhalter Mayo-Hegar 16 cm', req:1, cat:'Halten/N√§hen'}
      ],
      'ACH-102': [{id:'j1', name:'Trokare', req:3, cat:'Laparoskopie'}],
      'ACH-103': [{id:'k1', name:'Mei√üel 10mm', req:1, cat:'Ortho'}]
    };

    const COLUMNS = [
      {key:'img',label:'Set Bild',fixed:true}, {key:'code',label:'K√ºrzel',fixed:true}, {key:'name',label:'Set Bezeichnung',fixed:true},
      {key:'dept',label:'Fachgebiet'}, {key:'status',label:'Status'}, {key:'priority',label:'Priorit√§t'},
      {key:'owner',label:'Kostenstelle (Eig.)'}, {key:'issue',label:'Kostenstelle (Ausgabe)'},
      {key:'loan',label:'Leih-Set'}, {key:'risk',label:'Risikogruppe'}, {key:'type',label:'Typ'}
    ];
    const STORE_COLS='aemp.packplatz.columns.v1';

    const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

    function loadPrefs(){ try{ return JSON.parse(localStorage.getItem(STORE_COLS))||{} }catch{ return {} } }
    function savePrefs(p){ localStorage.setItem(STORE_COLS, JSON.stringify(p)); }
    function setColVisibility(key,on){ const th=document.querySelector(`th[data-key="${key}"]`); if(th) th.style.display=on?'':'none'; $$(`td[data-key="${key}"]`).forEach(td=> td.style.display=on?'':'none'); }

    function badgeStatus(s){ return `<span class="badge ok">${s}</span>`; }

    // Render left table
    function renderTable(){
      const tb = $('#tbl tbody'); tb.innerHTML='';
      for(const row of DATA){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="col-img sticky-0">${row.img?`<img src="${row.img}" alt="" style="width:64px;height:40px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.12)">`:''}</td>
          <td class="col-code sticky-1 mono">${row.code}</td>
          <td class="col-name sticky-2">${row.name}</td>
          <td data-key="dept">${row.dept||'‚Äî'}</td>
          <td data-key="status">${badgeStatus(row.status)}</td>
          <td data-key="priority">${row.priority||'‚Äî'}</td>
          <td data-key="owner">${row.owner||'‚Äî'}</td>
          <td data-key="issue">${row.issue||'‚Äî'}</td>
          <td data-key="loan">${row.loan||'‚Äî'}</td>
          <td data-key="risk">${row.risk||'‚Äî'}</td>
          <td data-key="type">${row.type||'‚Äî'}</td>`;
        tr.addEventListener('click',()=>selectSet(row.code));
        tb.appendChild(tr);
      }
      const prefs = loadPrefs();
      for(const col of COLUMNS){ if(col.fixed) continue; const on = prefs[col.key] !== false; setColVisibility(col.key, on); }
    }

    // Context menu for columns
    const menu = $('#colMenu');
    function buildMenu(){
      const prefs=loadPrefs(); const list=$('#colList'); list.innerHTML='';
      for(const col of COLUMNS){ if(col.fixed) continue; const on=prefs[col.key]!==false;
        const div=document.createElement('div'); div.className='item';
        div.innerHTML=`<input type="checkbox" id="chk-${col.key}" ${on?'checked':''}> <label for="chk-${col.key}">${col.label}</label>`;
        list.appendChild(div);
        div.querySelector('input').addEventListener('change',(ev)=>{ const p=loadPrefs(); p[col.key]=ev.currentTarget.checked; savePrefs(p); setColVisibility(col.key, ev.currentTarget.checked); });
      }
    }
    function showMenu(x,y){ buildMenu(); menu.style.display='block'; const rect=menu.getBoundingClientRect(); menu.style.left=Math.min(x, window.innerWidth-rect.width-8)+'px'; menu.style.top=Math.min(y, window.innerHeight-rect.height-8)+'px'; }
    function hideMenu(){ menu.style.display='none'; }
    document.addEventListener('click',(e)=>{ if(!menu.contains(e.target)) hideMenu(); });
    $('#hdr').addEventListener('contextmenu',(e)=>{ e.preventDefault(); showMenu(e.clientX,e.clientY); });

    // Barcode field -> open selection & dialog
    const scan = $('#scanInput');
    function focusScan(){ scan.focus({preventScroll:true}); scan.select(); }
    window.addEventListener('load', focusScan); window.addEventListener('focus', focusScan); document.addEventListener('visibilitychange',()=>{ if(!document.hidden) focusScan(); });

    function openByScan(){ const code=(scan.value||'').trim(); if(!code) return; selectSet(code); openPack(); }
    $('#scanOpen').addEventListener('click', openByScan);
    scan.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); openByScan(); } });

    // RIGHT detail population
    let currentCode = null;
    function selectSet(code){
      const row = DATA.find(r=>r.code===code); if(!row) return;
      currentCode = code;
      $('#dTitle').textContent = `${row.code} ‚Äì ${row.name}`;
      $('#dImg').src = row.img; $('#dCode').textContent = row.code; $('#dDept').textContent = row.dept||'';
      const meta = [
        ['Status', row.status], ['Priorit√§t', row.priority||'‚Äî'], ['Eigent√ºmer', row.owner||'‚Äî'], ['Ausgabe an', row.issue||'‚Äî'],
        ['Leih-Set', row.loan||'‚Äî'], ['Risikogruppe', row.risk||'‚Äî'], ['Typ', row.type||'‚Äî'], ['K√ºrzel', row.code]
      ];
      const dMeta = $('#dMeta'); dMeta.innerHTML=''; for(const [k,v] of meta){ const div=document.createElement('div'); div.innerHTML=`<div class="muted">${k}</div><div>${v}</div>`; dMeta.appendChild(div); }
      renderInst(code);
    }
    function renderInst(code){
      const body = $('#instBody'); body.innerHTML='';
      const items = DEMO_ITEMS[code]||[];
      for(const it of items){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.name}</td><td style="text-align:center">${it.req}</td><td>${it.cat||'‚Äî'}</td><td><button class="btn">Bilder hinzuf√ºgen</button></td>`; body.appendChild(tr); }
    }

    // Pack dialog reusing DEMO_ITEMS
    function openPack(){
      if(!currentCode) return;
      const items = (DEMO_ITEMS[currentCode]||[]).map(x=>Object.assign({}, x, {qty:x.req, state:'OK', reason:''}));
      document.getElementById('packTitle').textContent = `Packvorgang ‚Äì ${currentCode}`;
      const pb = document.getElementById('packBody'); pb.innerHTML='';
      for(const it of items){ const tr=document.createElement('tr'); tr.innerHTML = `<td>${it.name}</td><td style="text-align:center">${it.req}</td>
        <td style="text-align:center"><input type="number" min="0" max="${it.req}" value="${it.qty}" style="width:64px"></td>
        <td style="text-align:center">‚úî</td><td><select><option>‚Äî</option><option>verloren</option><option>defekt</option></select></td>`; pb.appendChild(tr); }
      document.getElementById('packDlg').showModal();
    }
    document.getElementById('btnPack').addEventListener('click', openPack);
    document.getElementById('btnCancel').addEventListener('click', ()=> alert('Storniert (Demo)'));
    document.getElementById('packClose').addEventListener('click', ()=> document.getElementById('packDlg').close());
    document.getElementById('packCancel').addEventListener('click', ()=> document.getElementById('packDlg').close());
    document.getElementById('packSave').addEventListener('click', ()=> document.getElementById('packDlg').close());
    document.getElementById('packComplete').addEventListener('click', ()=> document.getElementById('packDlg').close());

    // Initial render
    renderTable();
    selectSet(DATA[0].code);
  </script>
</body>
</html>
