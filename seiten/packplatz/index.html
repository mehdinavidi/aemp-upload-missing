<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AEMP ‚Ä¢ Packplatz ‚Äî V.1.1.23</title>
  <style>
    :root{
      --bg:#0b1222;--surface:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;
      --ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--radius:14px;--shadow:0 10px 30px rgba(0,0,0,.35);
      --w-img:72px; --w-code:150px; --w-name:260px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#0b1225 40%, #04070f 95%), var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Inter}
    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(120%) blur(10px);background:linear-gradient(180deg,rgba(2,6,23,.9),rgba(2,6,23,.6));border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1280px;margin:auto;padding:16px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:.5ch;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;color:#cbd5e1}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:#172033;color:var(--text);box-shadow:var(--shadow);cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.12)}
    input[type=text],select{background:#0b1020;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text);padding:10px 12px;outline:none}
    main{max-width:1280px;margin:22px auto;padding:0 16px 80px}
    .layout{display:grid;grid-template-columns: 48% 1fr; gap:16px}
    .card{background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(17,24,39,.75));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);gap:10px}
    .card-body{padding:10px 12px}
    .muted{color:#9fb0c8}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.16);border-radius:999px;padding:2px 8px;font-size:12px}
    .ok{color:#10b981;border-color:#10b98155}.warn{color:#f59e0b;border-color:#f59e0b55}.no{color:#ef4444;border-color:#ef444455}
    .table-wrap{overflow:auto;max-height:calc(80vh - 130px)}
    table{width:max(960px,100%);border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.08);text-align:left;vertical-align:middle;white-space:nowrap}
    thead th{position:sticky;top:0;background:rgba(17,24,39,.95);backdrop-filter:blur(6px);z-index:2;font-size:12px;color:#9fb0c8}
    tbody tr{cursor:pointer} tbody tr:hover td{background:rgba(255,255,255,.03)}
    th.sticky-0, td.sticky-0{position:sticky;left:0;z-index:3;background:linear-gradient(180deg,rgba(17,24,39,.98),rgba(17,24,39,.92))}
    th.sticky-1, td.sticky-1{position:sticky;left:var(--w-img);z-index:3;background:linear-gradient(180deg,rgba(17,24,39,.98),rgba(17,24,39,.92))}
    th.sticky-2, td.sticky-2{position:sticky;left:calc(var(--w-img) + var(--w-code));z-index:3;background:linear-gradient(180deg,rgba(17,24,39,.98),rgba(17,24,39,.92))}
    th.col-img, td.col-img{width:var(--w-img);min-width:var(--w-img);max-width:var(--w-img)}
    th.col-code, td.col-code{width:var(--w-code);min-width:var(--w-code)}
    th.col-name, td.col-name{width:var(--w-name);min-width:var(--w-name)}
    .ctx{position:fixed;display:none;min-width:250px;background:#0b1020;border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);border-radius:10px;padding:8px;z-index:10}
    .ctx h4{margin:6px 8px 8px;font-size:12px;color:#9fb0c8;text-transform:uppercase;letter-spacing:.6px}
    .ctx .item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px}
    .ctx .item:hover{background:rgba(255,255,255,.05)}
    .ctx input[type=checkbox]{accent-color:#22d3ee}
    .detail-title{display:flex;align-items:center;gap:12px}
    .detail-title img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.08)}
    .right-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    dialog{width:min(940px,96vw);border:0;border-radius:16px;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.94));color:var(--text);box-shadow:var(--shadow)}
    dialog::backdrop{backdrop-filter:blur(8px);background:rgba(0,0,0,.5)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.14);border-radius:999px;padding:4px 8px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="row" style="gap:8px">
          <a class="btn ghost" href="../../index.html">üè† Home</a>
          <span class="pill">AEMP ‚Ä¢ Packplatz</span>
        </div>
        <div class="row" style="gap:8px">
          <span class="pill">Version <strong>V.1.1.23</strong></span>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <label class="pill" for="scanInput">üîé Barcode/K√ºrzel:</label>
        <input id="scanInput" type="text" placeholder="z.‚ÄØB. ACH-101 oder SET-OR-123" style="min-width:320px">
        <button class="btn" id="scanOpen">Set √∂ffnen</button>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- LEFT: table of sets -->
      <section class="card">
        <div class="card-head">
          <strong>Sets</strong>
          <span class="muted">Rechtsklick im Tabellenkopf ‚Üí Spalten ein-/ausblenden</span>
        </div>
        <div class="table-wrap">
          <table id="tbl-left">
            <thead>
              <tr id="hdr-left">
                <th class="col-img sticky-0" data-key="img">Set Bild</th>
                <th class="col-code sticky-1" data-key="code">K√ºrzel</th>
                <th class="col-name sticky-2" data-key="name">Set Bezeichnung</th>
                <th data-key="dept">Fachbereich</th>
                <th data-key="status">Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT: details -->
      <section class="card" id="detail">
        <div class="card-head">
          <div class="detail-title">
            <img id="d-img" src="" alt="">
            <div>
              <h2 id="d-title" style="margin:0 0 4px 0;font-size:18px">‚Äì</h2>
              <div class="muted" id="d-sub">‚Äì</div>
            </div>
          </div>
          <button class="btn" id="btnAddImages">Bilder hinzuf√ºgen</button>
        </div>
        <div class="card-body">
          <table id="tbl-right">
            <thead>
              <tr>
                <th style="text-align:left">Instrument</th>
                <th>Soll</th>
                <th>Kategorie</th>
                <th>Bilder</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="right-footer">
            <a class="btn ghost" href="../../index.html">Home</a>
            <button class="btn ghost" id="btnPackform">Packformular</button>
            <button class="btn" style="background:#b91c1c" id="btnCancel">Stornieren</button>
            <button class="btn" style="background:#2563eb" id="btnPack">Packen</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Column context menu -->
  <div class="ctx" id="colMenu">
    <h4>Spalten anzeigen</h4>
    <div id="colList"></div>
  </div>

  <!-- Pack dialog -->
  <dialog id="packDlg">
    <div class="modal-head">
      <strong id="packTitle">Packvorgang</strong>
      <div>
        <span class="chip">‚úî <b id="cntOk">0</b></span>
        <span class="chip">‚ùó <b id="cntPartial">0</b></span>
        <span class="chip">‚úñ <b id="cntMissing">0</b></span>
        <button class="btn ghost" id="packClose">‚úï</button>
      </div>
    </div>
    <div style="padding:12px 14px">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th style="text-align:left">Instrument</th><th>Soll</th><th>Ist</th><th>Status</th><th>Grund</th><th>Aktion</th></tr></thead>
        <tbody id="packBody"></tbody>
      </table>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;padding:12px 14px;border-top:1px solid rgba(255,255,255,.06)">
      <button class="btn ghost" id="packCancel">Stornieren</button>
      <button class="btn" id="packSave">Speichern</button>
      <button class="btn" style="background:#22c55e" id="packComplete">Fertig packen</button>
    </div>
  </dialog>

  <script>
    // Demo data similar to screenshot semantics
    const SETS = [
      { code:'ACH-101', name:'Standard-OP Set', dept:'Chirurgie', status:'Freigegeben', img:'https://via.placeholder.com/72?text=Set' },
      { code:'ACH-102', name:'Laparoskopie Set', dept:'Chirurgie', status:'Freigegeben', img:'https://via.placeholder.com/72?text=Set' },
      { code:'ACH-103', name:'Orthop√§die Standard', dept:'Ortho', status:'Freigegeben', img:'https://via.placeholder.com/72?text=Set' },
    ];
    const ITEMS = {
      'ACH-101': [
        { id:'INST-1',  name:'Skalpellgriff Nr. 4',     req:2, cat:'Schneiden', img:true },
        { id:'INST-2',  name:'Schere Metzenbaum 14 cm', req:1, cat:'Schneiden', img:true },
        { id:'INST-3',  name:'Pinzette anatomisch 14 cm', req:2, cat:'Greifen', img:true },
        { id:'INST-4',  name:'Klemme Kocher gebogen',   req:2, cat:'Klemmen', img:true },
        { id:'INST-5',  name:'Nadelhalter Mayo-Hegar 16 cm', req:1, cat:'Halten/N√§hen', img:true },
      ],
      'ACH-102': [
        { id:'INST-10', name:'Trokar 5mm', req:2, cat:'Laparoskopie', img:false },
        { id:'INST-11', name:'Kameraoptik 30¬∞', req:1, cat:'Laparoskopie', img:false },
      ],
      'ACH-103': [
        { id:'INST-20', name:'Zange Luer', req:1, cat:'Ortho', img:false },
      ]
    };

    // Column config for left table
    const COLUMNS = [
      { key:'img', label:'Set Bild', fixed:true },
      { key:'code', label:'K√ºrzel', fixed:true },
      { key:'name', label:'Set Bezeichnung', fixed:true },
      { key:'dept', label:'Fachbereich' },
      { key:'status', label:'Status' },
    ];
    const STORE_COLS = 'aemp.packplatz.left.columns.v1';
    const STORE_SESS = 'aemp.pack.session.v1';

    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

    function loadPrefs(){ try{ return JSON.parse(localStorage.getItem(STORE_COLS)) || {} }catch{ return {} } }
    function savePrefs(p){ localStorage.setItem(STORE_COLS, JSON.stringify(p)); }
    function setColVisibility(key, on){
      const th = document.querySelector(`#hdr-left th[data-key="${key}"]`);
      if(th) th.style.display = on? '' : 'none';
      $$(`#tbl-left td[data-key="${key}"]`).forEach(td => td.style.display = on? '' : 'none');
    }

    function renderLeft(){
      const tb = $('#tbl-left tbody'); tb.innerHTML='';
      for(const s of SETS){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="col-img sticky-0">${s.img?`<img src="${s.img}" alt="" style="width:60px;height:40px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.1)">`:''}</td>
          <td class="col-code sticky-1">${s.code}</td>
          <td class="col-name sticky-2">${s.name}</td>
          <td data-key="dept">${s.dept}</td>
          <td data-key="status"><span class="badge ok">${s.status}</span></td>
        `;
        tr.addEventListener('click', ()=> selectSet(s.code));
        tb.appendChild(tr);
      }
      // apply column prefs
      const prefs = loadPrefs();
      for(const c of COLUMNS){
        if(c.fixed) continue;
        setColVisibility(c.key, prefs[c.key] !== false);
      }
    }

    function buildColMenu(){
      const list = $('#colList'); list.innerHTML='';
      const prefs = loadPrefs();
      for(const c of COLUMNS){
        if(c.fixed) continue;
        const on = prefs[c.key] !== false;
        const d = document.createElement('div');
        d.className='item';
        d.innerHTML = `<input type=checkbox id="chk-${c.key}" ${on?'checked':''}> <label for="chk-${c.key}">${c.label}</label>`;
        list.appendChild(d);
        d.querySelector('input').addEventListener('change', ev=>{
          const v = ev.currentTarget.checked;
          const p = loadPrefs(); p[c.key]=v; savePrefs(p);
          setColVisibility(c.key, v);
        });
      }
    }
    const menu = $('#colMenu');
    $('#hdr-left').addEventListener('contextmenu', e=>{ e.preventDefault(); buildColMenu(); menu.style.display='block'; const rect=menu.getBoundingClientRect(); menu.style.left = Math.min(e.clientX, innerWidth-rect.width-8)+'px'; menu.style.top = Math.min(e.clientY, innerHeight-rect.height-8)+'px'; });
    document.addEventListener('click', e=>{ if(!menu.contains(e.target)) menu.style.display='none'; });

    // Right panel selection
    function selectSet(code){
      const s = SETS.find(x=>x.code===code); if(!s) return;
      $('#d-img').src = s.img || '';
      $('#d-title').textContent = `${s.code} ‚Äì ${s.name}`;
      $('#d-sub').textContent = s.dept;
      const tb = $('#tbl-right tbody'); tb.innerHTML='';
      for(const it of (ITEMS[code]||[])){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.name}<div class="muted" style="font-size:12px">${it.id}</div></td>
                        <td style="text-align:center">${it.req}</td>
                        <td>${it.cat}</td>
                        <td>${it.img?'<button class="btn ghost">Bilder</button>':'<button class="btn">Bilder hinzuf√ºgen</button>'}</td>`;
        tb.appendChild(tr);
      }
      // remember last selected
      localStorage.setItem('aemp.packplatz.last', code);
    }

    // Restore last selected
    const last = localStorage.getItem('aemp.packplatz.last') || SETS[0].code;
    // Barcode field behavior
    const scan = document.getElementById('scanInput');
    function focusScan(){ scan.focus({preventScroll:true}); scan.select(); }
    window.addEventListener('load', focusScan);
    window.addEventListener('focus', focusScan);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) focusScan(); });
    setInterval(()=>{ if(document.activeElement!==scan) focusScan(); }, 5000);
    function openByScan(){
      const code=(scan.value||'').trim();
      if(!code) return;
      const s = SETS.find(x=>x.code.toLowerCase()===code.toLowerCase());
      if(s){ selectSet(s.code); openPack(s.code); }
    }
    document.getElementById('scanOpen').addEventListener('click', openByScan);
    scan.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); openByScan(); } });

    // Pack dialog logic (reusing earlier demo session format)
    const DEMO_ITEMS = {
      'ACH-101': [
        { id:'INST-1', name:'Skalpellgriff Nr. 4', req:2 },
        { id:'INST-2', name:'Schere Metzenbaum 14 cm', req:1 },
        { id:'INST-3', name:'Pinzette anatomisch 14 cm', req:2 },
        { id:'INST-4', name:'Klemme Kocher gebogen', req:2 },
        { id:'INST-5', name:'Nadelhalter Mayo-Hegar 16 cm', req:1 },
      ],
      'ACH-102': [{id:'INST-10',name:'Trokar 5mm',req:2},{id:'INST-11',name:'Kameraoptik 30¬∞',req:1}],
      'ACH-103': [{id:'INST-20',name:'Zange Luer',req:1}],
    };
    const dlg = document.getElementById('packDlg');
    const body = document.getElementById('packBody');
    function loadSession(code){ try{ const all=JSON.parse(localStorage.getItem(STORE_SESS))||{}; return all[code]||null }catch{ return null } }
    function saveSession(code,data){ const all=(function(){ try{return JSON.parse(localStorage.getItem(STORE_SESS))||{}}catch{return {}}})(); all[code]=data; localStorage.setItem(STORE_SESS, JSON.stringify(all)); }
    function openPack(code){
      const s = SETS.find(x=>x.code===code); if(!s) return;
      document.getElementById('packTitle').textContent = `Packvorgang ‚Äì ${s.code} ${s.name}`;
      let session = loadSession(code);
      if(!session){
        const items = (DEMO_ITEMS[code]||(ITEMS[code]||[])).map(x=>({id:x.id,name:x.name,req:x.req,qty:x.req,state:'OK',reason:''}));
        session = { code, status:'DRAFT', items };
        saveSession(code, session);
      }
      renderPack(session);
      dlg.showModal();
      setTimeout(focusScan,0);
    }
    function renderPack(session){
      body.innerHTML='';
      for(const it of session.items){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name}</td>
          <td style="text-align:center">${it.req}</td>
          <td style="text-align:center">
            <button class="btn ghost btn-minus" data-id="${it.id}">‚àí</button>
            <span class="qty" data-id="${it.id}" style="display:inline-block;min-width:2ch;text-align:center">${it.qty}</span>
            <button class="btn ghost btn-plus" data-id="${it.id}">+</button>
          </td>
          <td class="st" data-id="${it.id}" style="text-align:center"></td>
          <td>
            <select class="reason" data-id="${it.id}">
              <option value="">‚Äî</option>
              <option value="verloren">verloren</option>
              <option value="defekt">defekt</option>
              <option value="in Reparatur">in Reparatur</option>
              <option value="nicht vorhanden">nicht vorhanden</option>
            </select>
          </td>
          <td><button class="btn ghost btn-missing" data-id="${it.id}">als fehlend markieren</button></td>
        `;
        body.appendChild(tr);
        tr.querySelector('.reason').value = it.reason||'';
      }
      $$('.btn-minus',body).forEach(b=> b.addEventListener('click', ()=> changeQty(session,b.dataset.id,-1)));
      $$('.btn-plus',body).forEach(b=> b.addEventListener('click', ()=> changeQty(session,b.dataset.id,+1)));
      $$('.btn-missing',body).forEach(b=> b.addEventListener('click', ()=> setMissing(session,b.dataset.id)));
      $$('.reason',body).forEach(s=> s.addEventListener('change', e=> setReason(session,e.target.dataset.id,e.target.value)));
      recalcStates(session); updateCounters(session);
    }
    function renderState(state){ if(state==='OK') return '‚úî'; if(state==='PARTIAL') return '‚ùó'; if(state==='MISSING') return '‚úñ'; return '‚Äî'; }
    function changeQty(session,id,delta){
      const it=session.items.find(x=>x.id===id); if(!it) return;
      it.qty=Math.max(0,Math.min(it.req,(it.qty||0)+delta));
      it.state=(it.qty===it.req)?'OK':(it.qty===0?'MISSING':'PARTIAL');
      saveSession(session.code,session);
      body.querySelector(`.qty[data-id="${id}"]`).textContent = it.qty;
      body.querySelector(`.st[data-id="${id}"]`).innerHTML = renderState(it.state);
      const reasonSel=body.querySelector(`.reason[data-id="${id}"]`); if(reasonSel) reasonSel.disabled=(it.state==='OK');
      updateCounters(session);
    }
    function setMissing(session,id){
      const it=session.items.find(x=>x.id===id); if(!it) return;
      it.qty=0; it.state='MISSING'; saveSession(session.code,session); renderPack(session);
    }
    function setReason(session,id,reason){ const it=session.items.find(x=>x.id===id); if(!it) return; it.reason=reason; saveSession(session.code,session); }
    function recalcStates(session){
      for(const it of session.items){
        if(it.qty===it.req) it.state='OK'; else if(it.qty===0) it.state='MISSING'; else it.state='PARTIAL';
        const st=body.querySelector(`.st[data-id="${it.id}"]`); if(st) st.innerHTML = renderState(it.state);
        const reasonSel=body.querySelector(`.reason[data-id="${it.id}"]`); if(reasonSel) reasonSel.disabled=(it.state==='OK');
      }
    }
    function updateCounters(session){
      let ok=0,partial=0,miss=0; for(const it of session.items){ if(it.state==='OK') ok++; else if(it.state==='PARTIAL') partial++; else miss++; }
      document.getElementById('cntOk').textContent=ok; document.getElementById('cntPartial').textContent=partial; document.getElementById('cntMissing').textContent=miss;
    }
    document.getElementById('packClose').addEventListener('click', ()=> dlg.close());
    document.getElementById('packSave').addEventListener('click', ()=>{ dlg.close(); focusScan(); });
    document.getElementById('packCancel').addEventListener('click', ()=>{ dlg.close(); focusScan(); });
    document.getElementById('packComplete').addEventListener('click', ()=>{ dlg.close(); focusScan(); });

    // Init
    renderLeft();
    selectSet(last);
  </script>
</body>
</html>
